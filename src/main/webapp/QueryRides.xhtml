<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Find Rides</title>
    <h:outputStylesheet name="css/styles.css" />
    <script type="text/javascript">
        //<![CDATA[
        var specialDays = [];
        function highlightDays(date) {
            for (var i = 0; i < specialDays.length; i++) {
                var d = new Date(specialDays[i]);
                if (d.getDate() == date.getDate() && 
                    d.getMonth() == date.getMonth() && 
                    d.getFullYear() == date.getFullYear()) {
                    return [true, 'highlight-ride'];
                }
            }
            return [true, ''];
        }
        //]]>
    </script>
</h:head>
<h:body>

    <h:form id="findRidesForm">
        <p:panel header="Find rides" style="width: 80%; margin: 0 auto;">
            <h:messages id="messages" showDetail="true" closable="true" style="color:red">
                <p:autoUpdate />
            </h:messages>

            <h:panelGrid columns="2" style="width:100%;" columnClasses="td-top,td-top">
                
                <h:panelGroup style="display:block; text-align:center;">
                    <h:panelGrid columns="3" cellpadding="2" style="margin: 0 auto; text-align:left;">
                            <p:outputLabel for="from" value="Depart City" />
                            <p:selectOneMenu id="from" value="#{queryRidesBean.from}" required="true" requiredMessage="Please select a departure city.">
                                <f:selectItem itemLabel="Select City" itemValue="" />
                                <f:selectItems value="#{queryRidesBean.departCities}" />
                                <p:ajax event="change" update="to ridesTable calendarPanel" listener="#{queryRidesBean.searchRides}" />
                            </p:selectOneMenu>
                            <h:message for="from" />
                                
                            <p:outputLabel for="to" value="Arrival City" />
                            <p:selectOneMenu id="to" value="#{queryRidesBean.to}" required="true" requiredMessage="Please select an arrival city.">
                                <f:selectItem itemLabel="Select City" itemValue="" />
                                <f:selectItems value="#{queryRidesBean.destinationCities}" />
                                <p:ajax event="change" update="ridesTable calendarPanel" listener="#{queryRidesBean.searchRides}" />
                            </p:selectOneMenu>
                            <h:message for="to" />
                    </h:panelGrid>
                </h:panelGroup>

                <h:panelGroup style="text-align:center;">
                    <p:outputPanel id="calendarPanel" style="display:inline-block;">
                        <script type="text/javascript">
                            //<![CDATA[
                            specialDays = #{queryRidesBean.datesWithRidesJson};
                            //]]>
                        </script>
                        <p:calendar id="date" value="#{queryRidesBean.date}" pattern="MM/dd/yyyy" required="true" requiredMessage="Please select a date." 
                                    mode="inline" beforeShowDay="highlightDays">
                            <p:ajax event="dateSelect" listener="#{queryRidesBean.onDateSelect}" update="ridesTable" />
                        </p:calendar>
                    </p:outputPanel>
                    <p:message for="date" />
                </h:panelGroup>

            </h:panelGrid>

            <p:outputPanel id="ridesPanel" style="margin-top:10px; width: 80%; margin-left: auto; margin-right: auto;">
                <p:dataTable id="ridesTable" var="ride" value="#{queryRidesBean.rides}"
                             emptyMessage="No rides found for the selected criteria.">
                    <f:facet name="header">
                        Rides
                    </f:facet>
                    <p:column headerText="Driver">
                        <h:outputText value="#{ride.driver.name}" />
                    </p:column>
                    <p:column headerText="Seats">
                        <h:outputText value="#{ride.nPlaces}" />
                    </p:column>
                    <p:column headerText="Price">
                        <h:outputText value="#{ride.price}">
                            <f:convertNumber type="currency" currencySymbol="â‚¬" />
                        </h:outputText>
                    </p:column>
                    
                    <p:column headerText="Book" rendered="#{loginBean.traveler}" style="text-align: center;">
                        <p:commandButton value="Book" oncomplete="PF('bookDialog').show()" update=":findRidesForm:bookDialog" icon="pi pi-ticket">
                            <f:setPropertyActionListener value="#{ride}" target="#{queryRidesBean.selectedRide}" />
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
            </p:outputPanel>
            
            <p:dialog header="Book Ride" widgetVar="bookDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false">
                <p:outputPanel id="bookDialog" style="text-align:center;">
                    <h:panelGrid columns="2" cellpadding="5" rendered="#{not empty queryRidesBean.selectedRide}">
                        <h:outputLabel for="seats" value="Seats:" />
                        <p:spinner id="seats" value="#{queryRidesBean.seatsToBook}" min="1" max="#{queryRidesBean.selectedRide.nPlaces}" />
                        
                        <f:facet name="footer">
                            <p:commandButton value="Confirm" action="#{queryRidesBean.bookRide}" update=":findRidesForm:messages :findRidesForm:ridesTable" oncomplete="PF('bookDialog').hide()" />
                        </f:facet>
                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>
            
            <div style="text-align: center;">
            	<h:commandButton value="Close" action="#{queryRidesBean.close}" styleClass="btn" style="margin-top: 10px;" immediate="true" />
            </div>
        </p:panel>
    </h:form>
</h:body>
</html>